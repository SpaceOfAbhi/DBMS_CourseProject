<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Notes Portal</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Caveat+Brush&display=swap');

  body {
    font-family: 'Caveat Brush', cursive;
    margin: 0; padding: 0;
    background: url('https://images.unsplash.com/photo-1512820790803-83ca734da794') no-repeat center center fixed;
    background-size: cover;
    color: #333; position: relative;
  }
  body::before {
    content: "";
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(255,255,255,0.75); z-index: -1;
  }
  header {
    color: rgb(50, 0, 0);
    padding: 20px;
    text-align: center;
    border-radius: 15px;
    margin: 20px auto;
    max-width: 600px;
  }
  .container { width: 90%; margin: auto; padding: 20px; }
  .hidden { display: none; }
  .auth-box {
    max-width: 400px; margin: 80px auto;
    background: rgba(255,255,255,0.95); padding: 30px;
    border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
  }
  .auth-box input, .auth-box button {
    width: 100%; padding: 12px; margin: 12px 0;
    border-radius: 8px; border: 1px solid #ccc;
    font-size: 16px;
  }
  .auth-box button {
    background: linear-gradient(90deg, #ff7e5f, #feb47b);
    color: white; border: none; cursor: pointer; font-weight: bold;
    transition: transform 0.2s;
  }
  .auth-box button:hover { transform: scale(1.05); }
  .tiles {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; margin-top: 20px;
  }
  .tile {
    background: linear-gradient(145deg, #ffecd2, #fcb69f);
    padding: 25px; border-radius: 15px; box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    text-align: center; font-weight: bold; cursor: pointer;
    transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
  }
  .tile:hover {
    transform: scale(1.05);
    box-shadow: 0 12px 20px rgba(0,0,0,0.3);
    background: linear-gradient(145deg, #f6d365, #fda085);
  }
  .upload-btn {
    background: linear-gradient(90deg, #11998e, #38ef7d);
    color: white; padding: 15px 25px; border: none; border-radius: 10px;
    cursor: pointer; font-size: 16px; font-weight: bold;
    margin-bottom: 20px; transition: transform 0.2s;
  }
  .upload-btn:hover { transform: scale(1.05); box-shadow: 0 8px 15px rgba(0,0,0,0.3); }
  .note {
    background: rgba(255,255,255,0.9); padding: 20px; margin: 15px 0;
    border-radius: 15px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;
  }
  .note h3 { margin: 0; font-size: 18px; }
  .note .meta { font-size: 13px; color: #555; margin-top: 5px; }
  .note-buttons button {
    padding: 8px 15px; margin-left: 10px; border-radius: 5px; border: none;
    cursor: pointer; font-weight: bold; transition: transform 0.2s;
  }
  .note-buttons button:hover { transform: scale(1.05); }
  .view-btn { background: #3498db; color: white; }
  .delete-btn { background: #e74c3c; color: white; }
  form { max-width: 500px; background: rgba(255,255,255,0.95); padding: 25px; border-radius: 15px; margin: auto; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
  form input, form select { width: 100%; margin: 10px 0; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; }
  form button { background: linear-gradient(90deg, #6a11cb, #2575fc); color: white; border: none; padding: 14px; cursor: pointer; width: 100%; border-radius: 8px; font-size: 16px; }
</style>
</head>
<body>
<header><h1>Notes Portal</h1></header>

<div id="login" class="auth-box">
  <h2>Login</h2>
  <input id="loginEmail" type="text" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Password">
  <button onclick="loginUser()">Login</button>
  <p>Don't have an account? <a href="#" onclick="showPage('signup')">Signup</a></p>
</div>

<div id="signup" class="auth-box hidden">
  <h2>Signup</h2>
  <input id="signupName" type="text" placeholder="Name">
  <input id="signupEmail" type="text" placeholder="Email">
  <input id="signupPassword" type="password" placeholder="Password">
  <button onclick="signupUser()">Signup</button>
  <p>Already have an account? <a href="#" onclick="showPage('login')">Login</a></p>
</div>

<div id="departmentPage" class="container hidden">
  <button class="upload-btn" onclick="showPage('upload')">Upload Notes</button>
  <h2>Select Department</h2>
  <div class="tiles" id="departmentTiles"></div>
</div>

<div id="home" class="container hidden">
  <button class="upload-btn" onclick="showPage('departmentPage')">← Back to Departments</button>
  <h2>Select Semester</h2>
  <div class="tiles" id="semesterTiles"></div>
</div>

<div id="subjectsPage" class="container hidden">
  <button class="upload-btn" onclick="showPage('home')">← Back to Semesters</button>
  <h2 id="subjectsHeading">Subjects</h2>
  <div class="tiles" id="subjectsTiles"></div>
</div>

<div id="notesPage" class="container hidden">
  <button class="upload-btn" onclick="showPage('subjectsPage')">← Back to Subjects</button>
  <h2 id="notesHeading">Notes</h2>
  <div id="notesList"></div>
</div>

<div id="upload" class="container hidden">
  <button class="upload-btn" onclick="showPage('home')">← Back to Home</button>
  <h2>Upload Notes</h2>
  <form id="uploadForm">
    <select id="uploadDept">
      <option value="">Select Department</option>
      <option value="CSE">CSE</option>
      <option value="MECH">MECH</option>
      <option value="CIVIL">CIVIL</option>
      <option value="EEE">EEE</option>
      <option value="ECE">ECE</option>
      <option value="AIDS">AIDS</option>
      <option value="CSCY">CSCY</option>
      <option value="CSAI">CSAI</option>
    </select>
    <select id="uploadSem">
      <option value="">Select Semester</option>
      <option value="1">Sem 1</option>
      <option value="2">Sem 2</option>
      <option value="3">Sem 3</option>
      <option value="4">Sem 4</option>
      <option value="5">Sem 5</option>
      <option value="6">Sem 6</option>
      <option value="7">Sem 7</option>
      <option value="8">Sem 8</option>
    </select>
    <select id="uploadSubj">
      <option value="">Select Subject</option>
    </select>
    <input id="tagInput" type="text" placeholder="Tag">
    <input id="fileInput" type="file">
    <button type="submit">Upload</button>
  </form>
</div>

<script>
const API_URL = "http://localhost:5000";
let selectedDepartment = null;
let selectedSemester = null;

// Show page
function showPage(pageId){
  document.querySelectorAll("body > div").forEach(d=>d.classList.add("hidden"));
  document.getElementById(pageId).classList.remove("hidden");
}

// AUTH
async function loginUser(){
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  const res = await fetch(`${API_URL}/api/auth/login`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({email,password})
  });
  const data = await res.json();
  if(res.ok){ localStorage.setItem("token",data.token); alert("Login successful!"); renderDepartments(); showPage("departmentPage"); }
  else alert(data.error || "Login failed!");
}

async function signupUser(){
  const name = document.getElementById("signupName").value;
  const email = document.getElementById("signupEmail").value;
  const password = document.getElementById("signupPassword").value;
  const res = await fetch(`${API_URL}/api/auth/signup`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name,email,password})
  });
  const data = await res.json();
  if(res.ok){ alert("Signup successful! Please login."); showPage("login"); }
  else alert(data.error || "Signup failed!");
}

// Departments → Semesters → Subjects
const departmentList = ["CSE","MECH","CIVIL","EEE","ECE","AIDS","CSCY","CSAI"];
function renderDepartments(){
  const container = document.getElementById("departmentTiles");
  container.innerHTML = "";
  departmentList.forEach(dept=>{
    const div = document.createElement("div"); div.classList.add("tile"); div.textContent=dept;
    div.onclick=()=>openDepartment(dept); container.appendChild(div);
  });
}

function openDepartment(dept){
  selectedDepartment=dept; showPage("home");
  const container=document.getElementById("semesterTiles");
  container.innerHTML="";
  for(let i=1;i<=8;i++){
    const div=document.createElement("div"); div.classList.add("tile"); div.textContent=`Semester ${i}`;
    div.onclick=()=>openSemester(i); container.appendChild(div);
  }
}

// Subjects Data (added S6 subjects)
const subjectsData={
  "CSE":{
    5:["Computer Networks","System Software","Management of Software Systems","Disaster Management","Formal Language and Automata Theory","Microprocessors and Microcontrollers","Other"],
    6:["COMPILER DESIGN","COMPUTER GRAPHICS AND IMAGE PROCESSING","ALGORITHM ANALYSIS AND DESIGN","INDUSTRIAL ECONOMICS & FOREIGN TRADE"]
  }
};

function openSemester(sem){
  selectedSemester=sem; showPage("subjectsPage");
  document.getElementById("subjectsHeading").textContent=`${selectedDepartment} - Semester ${sem}`;
  loadSubjects(selectedDepartment,sem);
}

function loadSubjects(dept,sem){
  const container=document.getElementById("subjectsTiles"); container.innerHTML="";
  (subjectsData[dept]?.[sem] || ["No subjects available"]).forEach(sub=>{
    const div=document.createElement("div"); div.classList.add("tile"); div.textContent=sub;
    div.onclick=()=>loadNotes(dept,sem,sub); container.appendChild(div);
  });
}

// Load notes with VIEW and DELETE buttons
async function loadNotes(dept,sem,sub){
  showPage("notesPage");
  document.getElementById("notesHeading").textContent=`${sub} Notes`;
  const notesList=document.getElementById("notesList"); 
  notesList.innerHTML="<p>Loading notes...</p>";
  try{
    const res=await fetch(`${API_URL}/api/notes/subject/${sub}`,{
      headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}
    });
    const notes=await res.json();
    if(!notes || notes.length===0){ 
      notesList.innerHTML="<p>No notes available for this subject.</p>"; 
      return; 
    }
    notesList.innerHTML = "";
    notes.forEach(note=>{
      const div=document.createElement("div"); 
      div.classList.add("note");
      div.innerHTML=`
        <div>
          <h3>${note.subject} - ${note.tag||'No Tag'}</h3>
          <p class="meta">Uploaded by: ${note.uploadedBy?.username||'Unknown'} | Date: ${new Date(note.createdAt).toLocaleDateString()}</p>
        </div>
      `;

      const btnDiv=document.createElement("div"); 
      btnDiv.classList.add("note-buttons");

      // VIEW button
      const viewBtn=document.createElement("button"); 
      viewBtn.textContent="View"; 
      viewBtn.classList.add("view-btn");
      viewBtn.onclick=()=>window.open(note.fileUrl,"_blank");

      // DELETE button
      // DELETE button
const deleteBtn = document.createElement("button");
deleteBtn.textContent = "Delete";
deleteBtn.classList.add("delete-btn");

deleteBtn.onclick = async () => {
  if (!note._id) {
    alert("❌ Cannot delete: missing note ID.");
    console.error("Delete error: note has no _id", note);
    return;
  }

  if (confirm("Are you sure you want to delete this note?")) {
    try {
      const res = await fetch(`${API_URL}/api/notes/${note._id}`, {
        method: "DELETE",
        headers: {
          "Authorization": `Bearer ${localStorage.getItem("token")}`,
          "Content-Type": "application/json"
        }
      });

      const data = await res.json();

      if (res.ok) {
        alert("✅ Note deleted successfully!");
        loadNotes(selectedDepartment, selectedSemester, note.subject);
      } else {
        alert(`❌ ${data.error || "Failed to delete note."}`);
      }
    } catch (err) {
      console.error("Delete request error:", err);
      alert("❌ Server or network error while deleting.");
    }
  }
};


      btnDiv.appendChild(viewBtn);
      btnDiv.appendChild(deleteBtn);
      div.appendChild(btnDiv); 
      notesList.appendChild(div);
    });
  }catch(e){
    notesList.innerHTML="<p>Error loading notes.</p>"; 
    console.error(e);
  }
}

// Upload Form
const uploadDept=document.getElementById("uploadDept"); 
const uploadSem=document.getElementById("uploadSem"); 
const uploadSubj=document.getElementById("uploadSubj");

function updateUploadSubjects(){
  const dept=uploadDept.value; 
  const sem=uploadSem.value; 
  uploadSubj.innerHTML='<option value="">Select Subject</option>';
  if(subjectsData[dept]?.[sem]) subjectsData[dept][sem].forEach(sub=>{
    const opt=document.createElement("option"); opt.value=sub; opt.textContent=sub; uploadSubj.appendChild(opt);
  });
}

uploadDept.addEventListener("change",updateUploadSubjects); 
uploadSem.addEventListener("change",updateUploadSubjects);

document.getElementById("uploadForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const formData=new FormData();
  formData.append("department",uploadDept.value);
  formData.append("semester",uploadSem.value);
  formData.append("subject",uploadSubj.value);
  formData.append("tag",document.getElementById("tagInput").value);
  formData.append("file",document.getElementById("fileInput").files[0]);
  const res=await fetch(`${API_URL}/api/notes/upload`,{
    method:"POST",
    headers:{Authorization:`Bearer ${localStorage.getItem("token")}`},
    body:formData
  });
  const data=await res.json();
  if(res.ok){ 
    alert("Upload successful!"); 
    document.getElementById("uploadForm").reset();
    if(selectedDepartment && selectedSemester && uploadSubj.value) 
      loadNotes(selectedDepartment,selectedSemester,uploadSubj.value);
    else showPage("departmentPage");
  } else alert(data.error||"Upload failed!");
});
</script>
</body>
</html>
